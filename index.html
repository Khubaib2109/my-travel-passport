<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Travel Passport</title>


  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: #f5f5f5;
    }

    header {
      padding: 16px;
      background: #1f2937;
      color: white;
      font-size: 1.2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .layout {
      display: flex;
      height: calc(100vh - 64px);
    }

    .left-panel {
      width: 380px;
      overflow-y: auto;
      padding: 16px;
      background: #fafafa;
      border-right: 1px solid #ddd;
    }

    .card {
      background: white;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      font-size: 0.9rem;
    }

    .card h3 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 1rem;
    }

    label {
      font-size: 0.8rem;
      display: block;
      margin-bottom: 4px;
      color: #374151;
    }

    input, select {
      width: 100%;
      padding: 6px;
      margin-bottom: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.85rem;
    }

    button {
      padding: 8px 12px;
      border-radius: 999px;
      background: #2563eb;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .btn-secondary {
      background: #6b7280;
    }

    #map {
      flex: 1;
    }

    .trip-entry {
      border-bottom: 1px solid #eee;
      padding-bottom: 6px;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .trip-text {
      flex: 1;
    }

    .trip-delete {
      background: #fee2e2;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      color: #b91c1c;
      cursor: pointer;
      border: none;
      flex-shrink: 0;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 0.9rem;
    }

    .stats-box {
      background: #fff;
      border: 1px solid #ddd;
      padding: 8px;
      border-radius: 6px;
    }

    .small {
      font-size: 0.75rem;
      color: #6b7280;
    }
/* ---- MOBILE LAYOUT OVERRIDES (phones & small tablets) ---- */
@media (max-width: 900px) {
  /* Stack sidebar and map vertically */
  .layout {
    flex-direction: column;
    height: 100vh;           /* give the column a fixed height */
    width: 100%;
  }

  /* Sidebar should be full-width and scrollable if tall */
  .left-panel {
    width: 100%;
    max-height: 45vh;        /* top half-ish of the screen */
    overflow-y: auto;
    border-right: none;
    border-bottom: 1px solid #ddd;
  }

  /* Map sits underneath, full-width, with real height */
  #map {
    flex: 0 0 55vh;          /* stop flex:1; take ~55% of screen height */
    width: 100%;
    height: 55vh;
  }
}

  </style>
</head>

<body>

<header>
  <div>My Travel Passport</div>
  <div style="font-size:0.8rem; opacity:0.7;">Data stored locally</div>
</header>

<div class="layout">

  <div class="left-panel">

    <!-- Add Trip -->
    <div class="card">
      <h3>Add a Trip</h3>

      <form id="trip-form">
        <label>Mode</label>
        <select id="mode">
          <option value="flight">Flight ‚úàÔ∏è</option>
          <option value="train">Train üöÜ</option>
          <option value="bus">Bus üöå</option>
          <option value="other">Other</option>
        </select>

        <label>Date</label>
        <input type="date" id="date" required />

        <label>From (city)</label>
        <input id="from-place" placeholder="Sydney" />

        <label>To (city)</label>
        <input id="to-place" placeholder="Tokyo" />

        <label>Airline / Company (optional)</label>
        <input id="company" placeholder="Qantas, JR Rail" />

        <button type="submit">Add Trip</button>
        <button type="button" class="btn-secondary" id="clear-btn">Clear All</button>
      </form>
    </div>

    <!-- Stats -->
    <div class="card">
      <h3>Stats</h3>

      <label>Home city</label>
      <div style="display:flex; gap:4px; margin-bottom:6px;">
        <input id="home-input" placeholder="Sydney" style="flex:1;" />
        <button type="button" class="btn-secondary" id="set-home-btn" style="margin-bottom:0;">Set</button>
      </div>
      <p class="small">
        Current home: <strong><span id="home-label-display">Not set</span></strong><br/>
        Full trips from home (overall): <strong><span id="home-trip-count">0</span></strong>
      </p>

      <div class="stats-grid">
        <div class="stats-box">Segments: <span id="stat-trips">0</span></div>
        <div class="stats-box">Countries: <span id="stat-countries">0</span></div>
        <div class="stats-box">Flights: <span id="stat-flights">0</span></div>
        <div class="stats-box">Trains: <span id="stat-trains">0</span></div>
        <div class="stats-box">Buses: <span id="stat-buses">0</span></div>
        <div class="stats-box">Other: <span id="stat-other">0</span></div>
        <div class="stats-box" style="grid-column: span 2;">
          Distance: <span id="stat-distance">0 km</span>
        </div>
      </div>

      <p class="small" style="margin-top:6px;">
        Segments, distance & mode counts follow filters. Countries & full trips always use ALL trips.
      </p>
    </div>

    <!-- Filters -->
    <div class="card">
      <h3>Filters</h3>

      <label>Year</label>
      <select id="year-filter">
        <option value="">All years</option>
      </select>

      <label>Mode</label>
      <select id="mode-filter">
        <option value="">All modes</option>
        <option value="flight">Flights</option>
        <option value="train">Trains</option>
        <option value="bus">Buses</option>
        <option value="other">Other</option>
      </select>
    </div>

    <!-- Trip List + Export + Backup -->
    <div class="card">
      <h3>Your Trips</h3>
      <div id="trip-list"></div>

      <button id="export-btn" style="margin-top:10px;width:100%;">Export CSV</button>
      <button id="backup-json-btn" style="margin-top:6px;width:100%;">Download backup (JSON)</button>
      <button id="restore-json-btn" style="margin-top:6px;width:100%;">Restore from backup</button>

      <p class="small" style="margin-top:10px;">
        CSV columns: mode, date, from, to, airline/company.
      </p>
    </div>

  </div>

  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ---------------------------------------------------------
   STORAGE
--------------------------------------------------------- */
let trips = JSON.parse(localStorage.getItem("travel-trips") || "[]");
let homeLabel = localStorage.getItem("travel-home-label") || "";

function saveTrips() {
  localStorage.setItem("travel-trips", JSON.stringify(trips));
}

function saveHome() {
  if (homeLabel) {
    localStorage.setItem("travel-home-label", homeLabel);
  } else {
    localStorage.removeItem("travel-home-label");
  }
}

function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2);
}

/* ---------------------------------------------------------
   MAP INIT
--------------------------------------------------------- */
let map = L.map("map").setView([20, 0], 2);
L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
let layer = L.layerGroup().addTo(map);

/* ---------------------------------------------------------
   GEOCODING
--------------------------------------------------------- */
async function geocode(place) {
  const url =
    "https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=1&q=" +
    encodeURIComponent(place);

  const res = await fetch(url);
  const data = await res.json();
  if (!data.length) throw new Error("City not found: " + place);
  return data[0];
}

function labelFromGeo(g) {
  const a = g.address || {};
  const city =
    a.city || a.town || a.village || a.hamlet || g.display_name.split(",")[0];
  const country = a.country || "";
  return country ? `${city}, ${country}` : city;
}

/* ---------------------------------------------------------
   DISTANCE
--------------------------------------------------------- */
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI/180;
  const dLon = (lon2 - lon1) * Math.PI/180;
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* ---------------------------------------------------------
   HELPERS
--------------------------------------------------------- */
function getYear(dateStr) {
  return dateStr?.slice(0,4) || "";
}

function extractCountry(label) {
  if (!label) return "";
  const i = label.lastIndexOf(",");
  return i === -1 ? "" : label.slice(i+1).trim();
}

function countHomeJourneys(allTrips, homeLabel) {
  if (!homeLabel) return 0;
  const sorted = allTrips.slice().sort((a,b)=>a.date.localeCompare(b.date));

  let inJourney = false;
  let count = 0;

  for (const t of sorted) {
    if (!inJourney) {
      if (t.fromLabel === homeLabel && t.toLabel !== homeLabel) {
        inJourney = true;
      }
    } else {
      if (t.toLabel === homeLabel) {
        count++;
        inJourney = false;
      }
    }
  }
  return count;
}

/* ---------------------------------------------------------
   FILTERS
--------------------------------------------------------- */
function getFilteredTrips() {
  const year = document.getElementById("year-filter").value;
  const mode = document.getElementById("mode-filter").value;

  return trips.filter(t => {
    if (year && getYear(t.date) !== year) return false;
    if (mode && t.mode !== mode) return false;
    return true;
  });
}

function populateYearFilter() {
  const select = document.getElementById("year-filter");
  const years = new Set(trips.map(t => getYear(t.date)).filter(Boolean));
  const current = select.value;

  select.innerHTML = '<option value="">All years</option>';
  Array.from(years).sort().forEach(y => {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    select.appendChild(opt);
  });

  if (current) select.value = current;
}

/* ---------------------------------------------------------
   RENDER TRIP LIST
--------------------------------------------------------- */
function renderTripList(list) {
  const box = document.getElementById("trip-list");
  box.innerHTML = "";

  if (!list.length) {
    box.textContent = "No trips yet.";
    return;
  }

  list.slice().sort((a,b)=>a.date.localeCompare(b.date)).forEach(t => {
    const row = document.createElement("div");
    row.className = "trip-entry";

    const text = document.createElement("div");
    text.className = "trip-text";
    text.innerHTML = `
      <strong>${t.fromLabel} ‚Üí ${t.toLabel}</strong><br>
      ${t.date} ¬∑ ${t.mode}${t.company ? " ¬∑ " + t.company : ""}<br>
      ${t.distance.toFixed(1)} km
    `;

    const del = document.createElement("button");
    del.className = "trip-delete";
    del.textContent = "√ó";
    del.onclick = () => {
      trips = trips.filter(x => x.id !== t.id);
      saveTrips();
      renderAll();
    };

    row.appendChild(text);
    row.appendChild(del);
    box.appendChild(row);
  });
}

/* ---------------------------------------------------------
   RENDER STATS
--------------------------------------------------------- */
function renderStats(filtered) {
  document.getElementById("stat-trips").textContent = filtered.length;

  let dist = 0;
  const modes = { flight:0, train:0, bus:0, other:0 };

  filtered.forEach(t => {
    dist += t.distance;
    modes[t.mode] = (modes[t.mode] || 0) + 1;
  });

  document.getElementById("stat-flights").textContent = modes.flight;
  document.getElementById("stat-trains").textContent = modes.train;
  document.getElementById("stat-buses").textContent = modes.bus;
  document.getElementById("stat-other").textContent = modes.other;
  document.getElementById("stat-distance").textContent =
    filtered.length ? dist.toFixed(1) + " km" : "0 km";

  const countries = new Set();
  trips.forEach(t => {
    const c1 = extractCountry(t.fromLabel);
    const c2 = extractCountry(t.toLabel);
    if (c1) countries.add(c1);
    if (c2) countries.add(c2);
  });
  document.getElementById("stat-countries").textContent = countries.size;

  document.getElementById("home-label-display").textContent =
    homeLabel || "Not set";

  const fullTrips = countHomeJourneys(trips, homeLabel);
  document.getElementById("home-trip-count").textContent = fullTrips;
}

/* ---------------------------------------------------------
   SUBTLE ARC (non-weird curves)
--------------------------------------------------------- */
function makeArc(A, B, idx) {
  const midLat = (A[0] + B[0]) / 2;
  const midLon = (A[1] + B[1]) / 2;

  const offsets = [0.0, 0.5, -0.5, 0.8, -0.8];
  const off = offsets[idx % offsets.length];

  return [A, [midLat + off, midLon], B];
}

/* ---------------------------------------------------------
   RENDER MAP
--------------------------------------------------------- */
function renderMap(filtered) {
  layer.clearLayers();
  if (!filtered.length) return;

  const colors = ["#2563eb","#10b981","#f97316","#e11d48","#0d9488","#7c3aed"];
  const bounds = [];
  const routeIndexMap = {};

  filtered.forEach(t => {
    const A = [t.fromLat, t.fromLon];
    const B = [t.toLat, t.toLon];

    const key = [t.fromLabel, t.toLabel].slice().sort().join("|");
    const idx = routeIndexMap[key] || 0;
    routeIndexMap[key] = idx + 1;

    const arc = makeArc(A,B,idx);
    const color = colors[idx % colors.length];

    const line = L.polyline(arc, {color, weight:2}).addTo(layer);
    line.bindPopup(
      `${t.fromLabel} ‚Üí ${t.toLabel}<br>${t.date}<br>${t.distance.toFixed(1)} km`
    );

    L.circleMarker(A,{radius:4,color}).addTo(layer);
    L.circleMarker(B,{radius:4,color}).addTo(layer);

    bounds.push(A,B);
  });

  map.fitBounds(bounds, {padding:[20,20]});
}

/* ---------------------------------------------------------
   RENDER ALL
--------------------------------------------------------- */
function renderAll() {
  populateYearFilter();
  const filtered = getFilteredTrips();
  renderTripList(filtered);
  renderStats(filtered);
  renderMap(filtered);
}

/* ---------------------------------------------------------
   INIT
--------------------------------------------------------- */
document.getElementById("home-input").value = homeLabel || "";
renderAll();

/* ---------------------------------------------------------
   EVENTS
--------------------------------------------------------- */
document.getElementById("trip-form").onsubmit = async e => {
  e.preventDefault();

  const mode = document.getElementById("mode").value;
  const date = document.getElementById("date").value;
  const from = document.getElementById("from-place").value.trim();
  const to = document.getElementById("to-place").value.trim();
  const company = document.getElementById("company").value.trim();

  if (!date || !from || !to) return;

  try {
    const g1 = await geocode(from);
    const g2 = await geocode(to);

    const fromLabel = labelFromGeo(g1);
    const toLabel = labelFromGeo(g2);

    const dist = haversine(+g1.lat,+g1.lon,+g2.lat,+g2.lon);

    trips.push({
      id: generateId(),
      mode, date, fromLabel, toLabel,
      company,
      distance: dist,
      fromLat:+g1.lat, fromLon:+g1.lon,
      toLat:+g2.lat,   toLon:+g2.lon
    });

    saveTrips();
    document.getElementById("from-place").value = "";
    document.getElementById("to-place").value = "";
    document.getElementById("company").value = "";
    renderAll();

  } catch (err) {
    alert(err.message || "Could not find one of the cities.");
  }
};

document.getElementById("clear-btn").onclick = () => {
  if (confirm("Delete ALL trips?")) {
    trips = [];
    saveTrips();
    renderAll();
  }
};

document.getElementById("year-filter").onchange = renderAll;
document.getElementById("mode-filter").onchange = renderAll;

document.getElementById("set-home-btn").onclick = async () => {
  const raw = document.getElementById("home-input").value.trim();
  if (!raw) {
    homeLabel = "";
    saveHome();
    renderAll();
    return;
  }

  try {
    const g = await geocode(raw);
    homeLabel = labelFromGeo(g);
    document.getElementById("home-input").value = homeLabel;
    saveHome();
    renderAll();
  } catch (err) {
    alert(err.message || "Could not set home city.");
  }
};

/* ---------------------------------------------------------
   EXPORT CSV
--------------------------------------------------------- */
document.getElementById("export-btn").onclick = () => {
  if (!trips.length) {
    alert("No trips to export.");
    return;
  }

  const header = ["mode","date","from","to","company"];
  const rows = [header.join(",")];

  trips.forEach(t => {
    const cells = [
      t.mode, t.date, t.fromLabel, t.toLabel, t.company || ""
    ].map(x => String(x).replace(/"/g,'""'));
    rows.push('"' + cells.join('","') + '"');
  });

  const blob = new Blob([rows.join("\r\n")], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "my-travel-passport.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
};

/* ---------------------------------------------------------
   BACKUP / RESTORE (JSON)
--------------------------------------------------------- */
document.getElementById("backup-json-btn").onclick = () => {
  if (!trips.length && !homeLabel) {
    alert("Nothing to back up yet.");
    return;
  }

  const data = {
    trips,
    homeLabel
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], {
    type: "application/json;charset=utf-8;"
  });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "my-travel-passport-backup.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
};

document.getElementById("restore-json-btn").onclick = () => {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";

  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(reader.result);
        trips = Array.isArray(data.trips) ? data.trips : [];
        homeLabel = data.homeLabel || "";
        saveTrips();
        saveHome();
        document.getElementById("home-input").value = homeLabel;
        renderAll();
        alert("Backup restored!");
      } catch (err) {
        alert("Could not read backup file.");
      }
    };
    reader.readAsText(file);
  };

  input.click();
};
</script>

</body>
</html>
